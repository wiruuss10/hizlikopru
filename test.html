<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HÄ±zlÄ± KÃ¶prÃ¼ - Mobil v6.9.4</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #121212; color: white; text-align: center; padding: 15px; }
        .card { background: #1e1e1e; border-radius: 20px; padding: 25px; max-width: 400px; margin: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.5); border: 1px solid #333; }
        .room-tag { color: #00bcd4; font-weight: bold; margin-bottom: 20px; display: block; font-size: 20px; letter-spacing: 1px; }
        #display-area { background: #2a2a2a; padding: 20px; border-radius: 12px; margin: 15px 0; min-height: 110px; border: 1px dashed #444; position: relative; }
        #receivedImage { max-width: 100%; display: none; border-radius: 10px; margin-top: 10px; }
        #file-zone { display: none; margin-top: 12px; }
        .btn { border: none; padding: 15px; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; width: 100%; margin-top: 12px; font-size: 16px; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        textarea { width: 100%; height: 100px; background: #333; color: white; border: 1px solid #444; border-radius: 12px; padding: 12px; box-sizing: border-box; font-size: 15px; margin-top: 10px; }
        #status { font-size: 13px; color: #00bcd4; margin-top: 12px; height: 20px; font-weight: 500; }
        hr { border: 0; border-top: 1px solid #333; margin: 25px 0; }
    </style>
</head>
<body>
    <div class="card">
        <span id="room-tag" class="room-tag">BAÄLANILIYOR...</span>
        
        <div id="display-area">
            <div id="text-content">PC'den veri bekleniyor...</div>
            <img id="receivedImage" src="">
            <div id="file-zone">
                <p id="file-name" style="font-size: 12px; color: #aaa; margin-bottom: 8px;"></p>
                <a id="download-link" class="btn" style="background: #2e7d32; text-decoration: none; display: block;">ğŸ“¥ DOSYAYI Ä°NDÄ°R</a>
            </div>
        </div>

        <button class="btn" style="background: #333;" onclick="handleAction()">Kopyala / Kaydet</button>
        
        <hr>
        
        <textarea id="mobileInput" placeholder="PC'ye mesaj gÃ¶nder..."></textarea>
        <button class="btn" style="background: #00bcd4;" onclick="sendText()">ğŸ“ Metni GÃ¶nder</button>
        
        <input type="file" id="fileInput" style="display:none" onchange="uploadFile(this)">
        <button class="btn" style="background: #c0392b;" onclick="document.getElementById('fileInput').click()">ğŸ“ FotoÄŸraf / Dosya GÃ¶nder</button>
        
        <div id="status"></div>
    </div>

    <script>
        // 1. Oda AyarlarÄ±
        const urlParams = new URLSearchParams(window.location.search);
        let roomID = urlParams.get('room');

        if (!roomID) {
            roomID = prompt("Oda Ä°smi Girin (PC'deki ile aynÄ±):", "genel") || "genel";
        }

        roomID = roomID.toLowerCase().trim().replace(/[^a-z0-9]/g, '');
        const dbUrl = `https://hizlikopru-default-rtdb.europe-west1.firebasedatabase.app/${roomID}.json`;
        
        document.getElementById('room-tag').innerText = `ODA: ${roomID.toUpperCase()}`;

        // 2. YankÄ± Engelleme Ä°Ã§in DeÄŸiÅŸkenler
        let lastProcessedHash = "";

        // Veriyi Ã§ek ve ekrana bas
        function fetchData() {
            fetch(`${dbUrl}?nocache=${Date.now()}`).then(res => res.json()).then(data => {
                if (!data) return;

                // Verinin iÃ§eriÄŸinden benzersiz bir hash oluÅŸtur
                const currentHash = btoa(unescape(encodeURIComponent(data.content))).substring(0, 64);

                // EÄŸer veri bizden gelmiÅŸse (sender: WEB) veya hash aynÄ±ysa iÅŸleme
                if (data.sender === 'WEB' || currentHash === lastProcessedHash) return;

                lastProcessedHash = currentHash;

                // EkranÄ± temizle
                document.getElementById('text-content').style.display = 'none';
                document.getElementById('receivedImage').style.display = 'none';
                document.getElementById('file-zone').style.display = 'none';

                if (data.type === 'image') {
                    document.getElementById('receivedImage').src = data.content;
                    document.getElementById('receivedImage').style.display = 'block';
                } else if (data.type === 'file') {
                    const link = document.getElementById('download-link');
                    link.href = data.content;
                    link.download = data.filename || "indirilen_dosya";
                    document.getElementById('file-name').innerText = data.filename || "Dosya alÄ±ndÄ±";
                    document.getElementById('file-zone').style.display = 'block';
                } else {
                    document.getElementById('text-content').innerText = data.content;
                    document.getElementById('text-content').style.display = 'block';
                }
            }).catch(e => console.error("Hata:", e));
        }

        // Metin GÃ¶nder
        function sendText() {
            const val = document.getElementById('mobileInput').value;
            if(!val) return;
            
            showStatus("GÃ¶nderiliyor...");
            
            const payload = { 
                content: val, 
                timestamp: Date.now() / 1000, 
                type: 'text', 
                sender: 'WEB' 
            };

            // GÃ¶nderdiÄŸimiz verinin hash'ini kaydediyoruz ki geri okumayalÄ±m
            lastProcessedHash = btoa(unescape(encodeURIComponent(val))).substring(0, 64);

            fetch(dbUrl, { method: 'PUT', body: JSON.stringify(payload) })
                .then(() => {
                    document.getElementById('mobileInput').value = "";
                    showStatus("PC'ye Ä°letildi âœ…");
                });
        }

        // Dosya/Resim YÃ¼kle
        function uploadFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            showStatus("HazÄ±rlanÄ±yor...");
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const base64Data = e.target.result;
                const payload = {
                    content: base64Data,
                    filename: file.name,
                    timestamp: Date.now() / 1000,
                    type: file.type.startsWith('image/') ? 'image' : 'file',
                    sender: 'WEB'
                };

                lastProcessedHash = btoa(unescape(encodeURIComponent(base64Data))).substring(0, 64);
                
                showStatus("YÃ¼kleniyor...");
                fetch(dbUrl, { method: 'PUT', body: JSON.stringify(payload) })
                    .then(() => showStatus("Dosya GÃ¶nderildi âœ…"));
            };
            reader.readAsDataURL(file);
        }

        // Kopyalama Butonu Ä°ÅŸlevi
        function handleAction() {
            const textElem = document.getElementById('text-content');
            if(textElem.style.display !== 'none' && textElem.innerText !== "PC'den veri bekleniyor...") {
                navigator.clipboard.writeText(textElem.innerText);
                showStatus("Metin KopyalandÄ± ğŸ“‹");
            } else if (document.getElementById('file-zone').style.display !== 'none') {
                document.getElementById('download-link').click();
                showStatus("Dosya Ä°ndiriliyor...");
            }
        }

        function showStatus(m) { 
            const s = document.getElementById('status');
            s.innerText = m; 
            setTimeout(() => { if(s.innerText === m) s.innerText = ""; }, 3000); 
        }

        // 2 saniyede bir yeni veri var mÄ± diye kontrol et
        setInterval(fetchData, 2000);
        fetchData();
    </script>
</body>
</html>
