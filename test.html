<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hƒ±zlƒ± K√∂pr√º Liste v8.0</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; padding: 15px; }
        .card { background: #1e1e1e; border-radius: 20px; padding: 20px; max-width: 450px; margin: auto; border: 1px solid #333; }
        .room-tag { color: #00bcd4; font-weight: bold; margin-bottom: 20px; display: block; font-size: 20px; }
        #history-list { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg-item { background: #2a2a2a; padding: 15px; border-radius: 12px; border-left: 5px solid #00bcd4; text-align: left; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-time { font-size: 10px; color: #777; float: right; }
        .msg-content { margin-top: 8px; font-size: 14px; word-break: break-all; }
        .download-btn { background: #2e7d32; color: white; padding: 10px; display: block; border-radius: 8px; text-decoration: none; font-size: 14px; margin-top: 10px; text-align: center; font-weight: bold; }
        .btn-main { border: none; padding: 15px; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; font-size: 16px; }
        textarea { width: 100%; height: 80px; background: #333; color: white; border: 1px solid #444; border-radius: 12px; padding: 12px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="card">
        <span id="room-tag" class="room-tag">ODA: BAƒûLANILIYOR...</span>
        
        <textarea id="mobileInput" placeholder="PC'ye mesaj g√∂nderin..."></textarea>
        <button class="btn-main" style="background: #00bcd4;" onclick="sendText()">üìù Metni G√∂nder</button>
        <input type="file" id="fileInput" style="display:none" onchange="uploadFile(this)">
        <button class="btn-main" style="background: #c0392b;" onclick="document.getElementById('fileInput').click()">üìÅ Dosya Se√ß</button>
        
        <div id="history-list">
            <p style="color:#666; margin-top: 20px;">Gelen dosyalar burada listelenecek...</p>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let roomID = urlParams.get('room') || prompt("Oda ƒ∞smi:");
        roomID = roomID.toLowerCase().trim().replace(/[^a-z0-9]/g, '');
        
        const dbUrl = `https://hizlikopru-default-rtdb.europe-west1.firebasedatabase.app/${roomID}/messages.json`;
        let processedIds = new Set();
        document.getElementById('room-tag').innerText = `ODA: ${roomID.toUpperCase()}`;

        function fetchData() {
            fetch(`${dbUrl}?limitToLast=10&nocache=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                if (!data) return;
                
                // Gelen her mesajƒ± ID'sine g√∂re kontrol et ve ekle
                Object.keys(data).forEach(id => {
                    if (!processedIds.has(id)) {
                        processedIds.add(id);
                        if (data[id].sender === 'PC') {
                            addToUI(data[id]);
                        }
                    }
                });
            });
        }

        function addToUI(data) {
            const list = document.getElementById('history-list');
            if (list.innerHTML.includes("listelenecek")) list.innerHTML = "";

            const item = document.createElement('div');
            item.className = 'msg-item';
            const timeStr = new Date(data.timestamp * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let contentHtml = "";
            if (data.type === 'image') {
                contentHtml = `<img src="${data.content}" style="max-width:100%; border-radius:8px;">`;
            } else if (data.type === 'file') {
                contentHtml = `<div>üì¶ <b>${data.filename}</b></div>
                               <a href="${data.content}" download="${data.filename}" class="download-btn">üì• DOSYAYI ƒ∞NDƒ∞R</a>`;
            } else {
                contentHtml = `<div class="msg-content">${data.content}</div>`;
            }

            item.innerHTML = `<span class="msg-time">${timeStr}</span>${contentHtml}`;
            list.insertBefore(item, list.firstChild);
        }

        function sendText() {
            const val = document.getElementById('mobileInput').value;
            if(!val) return;
            fetch(dbUrl, { method: 'POST', body: JSON.stringify({ content: val, timestamp: Date.now()/1000, type: 'text', sender: 'WEB' }) })
            .then(() => { document.getElementById('mobileInput').value = ""; alert("G√∂nderildi!"); });
        }

        function uploadFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                fetch(dbUrl, { method: 'POST', body: JSON.stringify({ content: e.target.result, filename: file.name, timestamp: Date.now()/1000, type: file.type.startsWith('image/') ? 'image' : 'file', sender: 'WEB' }) })
                .then(() => alert("Dosya ƒ∞letildi!"));
            };
            reader.readAsDataURL(file);
        }

        setInterval(fetchData, 2000);
        fetchData();
    </script>
</body>
</html>
